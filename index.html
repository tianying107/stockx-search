<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockX Auth Code Retriever</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Validation Page -->
    <div id="validation-page" class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Access Restricted</h1>
        <p class="text-gray-600 mb-6">
            Please enter the password to access the application.
        </p>
        <div class="mb-4">
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter password">
        </div>
        <button id="login-button" class="bg-indigo-600 text-white font-medium py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
            Log In
        </button>
        <p id="validation-message" class="text-xs text-red-500 mt-2 hidden">Invalid password. Please try again.</p>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <div id="auth-container" class="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">StockX Authorization Code Retriever</h1>
            <p class="text-gray-600 mb-6">
                Follow the steps below to get your authorization code and then your access token. This tool does not store your credentials.
            </p>
            
            <!-- Step 1: Link to StockX -->
            <div id="step-one" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Step 1: Log in and Authorize</h2>
                <p class="text-sm text-gray-500 mb-4">
                    Click the button below to be redirected to the StockX login page. After you log in and authorize the application, you will be redirected back to this page with the authorization code.
                </p>
                <button id="auth-button" class="bg-indigo-600 text-white font-medium py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                    Authorize with StockX
                </button>
            </div>

            <!-- Step 2: Display Authorization Code -->
            <div id="step-two" class="hidden mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Step 2: Your Authorization Code</h2>
                <p class="text-sm text-gray-500 mb-4">
                    The code below was retrieved from the URL. Copy it or click 'Use Code' to proceed to the next step.
                </p>
                <textarea id="code-display" readonly class="w-full h-24 p-3 font-mono text-sm bg-gray-50 rounded-lg border border-gray-300 resize-none overflow-auto shadow-inner"></textarea>
                <button id="copy-code-button" class="bg-green-500 text-white font-medium py-2 px-4 rounded-xl shadow-lg mt-4 hover:bg-green-600 transition duration-300">
                    Copy Code
                </button>
                <button id="use-code-button" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-xl shadow-lg mt-4 hover:bg-indigo-700 transition duration-300 ml-4">
                    Use Code
                </button>
                <p id="copy-code-message" class="text-xs text-green-600 mt-2 opacity-0 transition-opacity duration-300">Copied!</p>
            </div>

            <!-- Step 3: Get Access Token -->
            <div id="step-three" class="hidden mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Step 3: Get Access Token</h2>
                <p class="text-sm text-gray-500 mb-4">
                    Click the button below to exchange the authorization code for an access token.
                </p>
                <button id="get-token-button" class="bg-blue-600 text-white font-medium py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    Get Access Token
                </button>
                <div id="token-display" class="hidden mt-6 text-left">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-gray-700">Access Token</h3>
                        <textarea id="access-token-display" readonly class="w-full h-24 p-3 font-mono text-sm bg-gray-50 rounded-lg border border-gray-300 resize-none overflow-auto shadow-inner mt-2"></textarea>
                        <button id="copy-access-token-button" class="bg-green-500 text-white font-medium py-2 px-4 rounded-xl shadow-lg mt-2 hover:bg-green-600 transition duration-300">
                            Copy Access Token
                        </button>
                    </div>
                </div>
                <button id="proceed-to-step-4-button" class="bg-gray-400 text-white font-medium py-2 px-4 rounded-xl shadow-lg mt-4 hover:bg-gray-500 transition duration-300 transform hover:scale-105">
                    Proceed to Step 4
                </button>
            </div>

            <!-- Step 4: Product Search and Selection -->
            <div id="product-search-section" class="hidden mt-8 bg-gray-50 p-6 rounded-2xl shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 4: Find Product and Get Bid</h2>
                <p class="text-sm text-gray-500 mb-4">
                    Enter a product description to search for an item.
                </p>
                <div class="mb-4">
                    <label for="product-query" class="block text-gray-700 font-medium text-left mb-1">Product Description:</label>
                    <input type="text" id="product-query" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Yeezy Boost 350 V2 Beluga">
                </div>
                <button id="search-button" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                    Search Product
                </button>

                <!-- Product Selection Section -->
                <div id="product-list-section" class="hidden mt-6 text-left">
                    <label for="product-select" class="block text-gray-700 font-medium mb-1">Select a Product:</label>
                    <select id="product-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4"></select>
                    <button id="select-product-button" class="bg-green-600 text-white font-medium py-2 px-4 rounded-xl shadow-lg hover:bg-green-700 transition duration-300">
                        Select Product
                    </button>
                </div>
                
                <!-- Variants Table Section -->
                <div id="variants-table-section" class="hidden mt-6 text-left">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Highest Bids by Variant</h3>
                    <div class="overflow-x-auto rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Variant</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Highest Bid</th>
                                </tr>
                            </thead>
                            <tbody id="bids-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Bids will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <button id="back-to-search-button" class="hidden bg-gray-400 text-white font-medium py-2 px-4 rounded-xl shadow-lg mt-4 hover:bg-gray-500 transition duration-300">
                    Back to Search
                </button>

            </div>

            <!-- Status & Message -->
            <div id="status-message" class="text-sm text-gray-400 mt-6"></div>
        </div>
    </div>

    <script>
        const CLIENT_ID = 'bIQrwMpNVs2dj2N5QmCx1TUJm8GdgnzL';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const CLIENT_SECRET = '5pCGn0XR2xCa4K6shFZqW1M0n6peSSi5ztMzpL20_pK7AMXghNjUcaMvQegW0rZv';
        const API_KEY = 'Zi3jWkYRWx1wIQ8VEaOXh4piarIpjwXj3utuH7Ct';
        const CORS_PROXY = 'https://corsproxy.io/?';

        const HASHED_PASSWORD = 'b3a74966601f70f612543950a7190f7f189c441c2c8f8e79b90c102a0a202d6b';
        const SALT = 'e_stockx_app_salt_2024';

        let currentProductId = null;

        const statusMessage = document.getElementById('status-message');
        const stepOne = document.getElementById('step-one');
        const stepTwo = document.getElementById('step-two');
        const stepThree = document.getElementById('step-three');
        const productSearchSection = document.getElementById('product-search-section');

        // Function to hash a string using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        document.getElementById('auth-button').addEventListener('click', () => {
            const authUrl = `https://accounts.stockx.com/authorize?` +
                            `response_type=code&` +
                            `client_id=${CLIENT_ID}&` +
                            `redirect_uri=${REDIRECT_URI}&` +
                            `scope=offline_access%20openid&` +
                            `audience=gateway.stockx.com`;
            window.location.href = authUrl;
        });

        document.getElementById('copy-code-button').addEventListener('click', () => {
            const codeDisplay = document.getElementById('code-display');
            codeDisplay.select();
            document.execCommand('copy');
            const message = document.getElementById('copy-code-message');
            message.classList.add('opacity-100');
            setTimeout(() => {
                message.classList.remove('opacity-100');
            }, 2000);
        });

        document.getElementById('use-code-button').addEventListener('click', () => {
            stepThree.classList.remove('hidden');
            statusMessage.textContent = 'Authorization code ready. Click "Get Access Token" to proceed.';
        });
        
        document.getElementById('proceed-to-step-4-button').addEventListener('click', () => {
            productSearchSection.classList.remove('hidden');
            statusMessage.textContent = 'You can now search for products to get their bids.';
        });

        document.getElementById('copy-access-token-button').addEventListener('click', () => {
            const tokenDisplay = document.getElementById('access-token-display');
            tokenDisplay.select();
            document.execCommand('copy');
        });

        document.getElementById('get-token-button').addEventListener('click', () => {
            const authCode = document.getElementById('code-display').value;
            if (authCode && authCode !== 'Token not found.') {
                exchangeCodeForToken(authCode);
            } else {
                statusMessage.textContent = 'Please provide a valid authorization code first.';
            }
        });
        
        document.getElementById('search-button').addEventListener('click', searchProduct);
        document.getElementById('product-select').addEventListener('change', () => {
            document.getElementById('variants-table-section').classList.add('hidden');
            document.getElementById('back-to-search-button').classList.add('hidden');
        });
        document.getElementById('select-product-button').addEventListener('click', () => {
            const selectedProductUUID = document.getElementById('product-select').value;
            currentProductId = selectedProductUUID;
            fetchAndDisplayAllBids(document.getElementById('access-token-display').value, currentProductId);
        });
        document.getElementById('back-to-search-button').addEventListener('click', () => {
            document.getElementById('product-list-section').classList.remove('hidden');
            document.getElementById('variants-table-section').classList.add('hidden');
            document.getElementById('back-to-search-button').classList.add('hidden');
            statusMessage.textContent = 'Select a new product to view its bids.';
        });

        async function exchangeCodeForToken(authCode) {
            statusMessage.textContent = 'Exchanging code for token...';
            try {
                const response = await fetch('https://accounts.stockx.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        redirect_uri: REDIRECT_URI,
                        code: authCode
                    })
                });

                const data = await response.json();
                console.log('Token exchange response:', data);
                
                if (response.ok) {
                    const accessToken = data.access_token || 'Token not found.';
                    localStorage.setItem('stockx_access_token', accessToken);
                    
                    document.getElementById('access-token-display').value = accessToken;
                    
                    statusMessage.textContent = 'Successfully received an access token! You can now proceed to Step 4.';
                    
                    document.getElementById('token-display').classList.remove('hidden');
                    document.getElementById('proceed-to-step-4-button').classList.remove('bg-gray-400', 'cursor-not-allowed');
                    document.getElementById('proceed-to-step-4-button').classList.add('bg-indigo-600');
                } else {
                    statusMessage.textContent = `Error: ${data.error_description || data.error}`;
                }
            } catch (error) {
                statusMessage.textContent = `An error occurred: ${error.message}`;
                console.error('Error fetching token:', error);
            }
        }
        
        async function searchProduct() {
            const accessToken = document.getElementById('access-token-display').value;
            const query = document.getElementById('product-query').value;

            if (!accessToken || accessToken === 'Token not found.') {
                statusMessage.textContent = 'Please get an access token first to perform a search.';
                return;
            }

            if (!query) {
                statusMessage.textContent = 'Please enter a product description to search.';
                return;
            }

            statusMessage.textContent = 'Searching for product...';
            try {
                const url = `${CORS_PROXY}https://api.stockx.com/v2/catalog/search?query=${encodeURIComponent(query)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('stockx_access_token');
                    statusMessage.textContent = 'Session expired. Please click "Authorize with StockX" to get a new token.';
                    resetUI();
                    return;
                }

                const data = await response.json();
                console.log('Search response:', data);

                if (response.ok && data.products && data.products.length > 0) {
                    const productSelect = document.getElementById('product-select');
                    productSelect.innerHTML = '';
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.productId;
                        option.textContent = `${product.title} (${product.styleId})`;
                        productSelect.appendChild(option);
                    });
                    document.getElementById('product-list-section').classList.remove('hidden');
                    document.getElementById('variants-table-section').classList.add('hidden');
                    document.getElementById('back-to-search-button').classList.add('hidden');
                    statusMessage.textContent = 'Products found. Please select one to continue.';
                } else {
                    statusMessage.textContent = 'No products found for that query.';
                    document.getElementById('product-list-section').classList.add('hidden');
                    document.getElementById('variants-table-section').classList.add('hidden');
                    document.getElementById('back-to-search-button').classList.add('hidden');
                }
            } catch (error) {
                statusMessage.textContent = `An error occurred during search: ${error.message}`;
                console.error('Search error:', error);
            }
        }

        async function fetchAndDisplayAllBids(accessToken, productId) {
            statusMessage.textContent = 'Retrieving and analyzing bids for all variants...';
            document.getElementById('variants-table-section').classList.add('hidden');
            document.getElementById('back-to-search-button').classList.add('hidden');
            document.getElementById('product-list-section').classList.add('hidden');

            try {
                const variantsUrl = `${CORS_PROXY}https://api.stockx.com/v2/catalog/products/${productId}/variants`;
                const variantsResponse = await fetch(variantsUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (variantsResponse.status === 401) {
                    localStorage.removeItem('stockx_access_token');
                    statusMessage.textContent = 'Session expired. Please click "Authorize with StockX" to get a new token.';
                    resetUI();
                    return;
                }

                const variants = await variantsResponse.json();
                
                if (!variants || variants.length === 0) {
                    statusMessage.textContent = 'No variants found for this product.';
                    return;
                }

                const marketDataPromises = variants.map(variant => {
                    const marketDataUrl = `${CORS_PROXY}https://api.stockx.com/v2/catalog/products/${productId}/variants/${variant.variantId}/market-data`;
                    return fetch(marketDataUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'X-Api-Key': API_KEY,
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json())
                      .then(marketData => {
                          if (marketData.highestBidAmount && marketData.highestBidAmount > 0) {
                            return {
                                variantName: variant.variantValue,
                                highestBid: marketData.highestBidAmount,
                                currency: marketData.currencyCode || ''
                            };
                          }
                          return null;
                      })
                      .catch(error => {
                          console.error(`Error fetching market data for variant ${variant.variantId}:`, error);
                          return null;
                      });
                });

                const allBids = (await Promise.all(marketDataPromises)).filter(bid => bid !== null);
                allBids.sort((a, b) => b.highestBid - a.highestBid);

                const tableBody = document.getElementById('bids-table-body');
                tableBody.innerHTML = '';
                
                if (allBids.length === 0) {
                    statusMessage.textContent = 'No highest bids found for any variant of this product.';
                    document.getElementById('product-list-section').classList.remove('hidden');
                    return;
                }

                allBids.forEach((bid, index) => {
                    const row = document.createElement('tr');
                    const isHighest = index === 0;
                    row.classList.add('hover:bg-gray-50');
                    if (isHighest) {
                        row.classList.add('bg-green-100', 'font-semibold', 'text-green-800');
                    }

                    const variantCell = document.createElement('td');
                    variantCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                    variantCell.textContent = bid.variantName;

                    const bidCell = document.createElement('td');
                    bidCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                    bidCell.textContent = `$${bid.highestBid} ${bid.currency}`;

                    row.appendChild(variantCell);
                    row.appendChild(bidCell);
                    tableBody.appendChild(row);
                });

                document.getElementById('variants-table-section').classList.remove('hidden');
                document.getElementById('back-to-search-button').classList.remove('hidden');
                statusMessage.textContent = 'Highest bids for all variants retrieved and displayed.';
            } catch (error) {
                statusMessage.textContent = `An error occurred while getting bids: ${error.message}`;
                console.error('Error fetching bids:', error);
            }
        }
        
        function resetUI() {
            stepOne.classList.remove('hidden');
            stepTwo.classList.add('hidden');
            stepThree.classList.add('hidden');
            productSearchSection.classList.add('hidden');
            document.getElementById('access-token-display').value = '';
        }

        async function checkAuth() {
            const validationPage = document.getElementById('validation-page');
            const mainApp = document.getElementById('main-app');
            const authorizedSession = localStorage.getItem('authorized_session');

            if (authorizedSession) {
                validationPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('code');
                const storedToken = localStorage.getItem('stockx_access_token');
            
                if (authCode) {
                    stepOne.classList.add('hidden');
                    stepTwo.classList.remove('hidden');
                    document.getElementById('code-display').value = authCode;
                    statusMessage.textContent = 'Authorization code received. Copy the code or click "Use Code" to proceed.';
                } else if (storedToken) {
                    stepOne.classList.add('hidden');
                    stepTwo.classList.add('hidden');
                    stepThree.classList.add('hidden');
                    productSearchSection.classList.remove('hidden');
                    document.getElementById('access-token-display').value = storedToken;
                    statusMessage.textContent = 'Welcome back! Your previous session was restored. You can now search for products.';
                } else {
                    statusMessage.textContent = 'Click the button to begin.';
                }

            } else {
                validationPage.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        }

        window.onload = checkAuth;

        document.getElementById('login-button').addEventListener('click', async () => {
            const passwordInput = document.getElementById('password-input').value;
            const validationMessage = document.getElementById('validation-message');
            
            const hashedAttempt = await hashPassword(passwordInput + SALT);

            if (hashedAttempt === HASHED_PASSWORD) {
                localStorage.setItem('authorized_session', 'true');
                validationMessage.classList.add('hidden');
                checkAuth();
            } else {
                validationMessage.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
